# 管理 Zone


Zone 是{{nebula.name}}中存储（Storage）节点的逻辑机架，它将多个 Storage 节点划分成可管理的逻辑区域，实现资源隔离。同时，用户可以控制 Graph 服务访问指定的 Zone 内的副本数据，从而减少流量消耗，提高访问效率。本文介绍如何使用 Zone 功能。

## 原理介绍

用户可以将 Storage 节点加入某个 Zone 中，创建图空间时指定 Zone 的列表，就会在这些 Zone 内的 Storage 节点上创建及存储图空间。分片副本会均匀存储在各个 Zone 中。如下图所示。

![Zone 示意图](https://docs-cdn.nebula-graph.com.cn/figures/zone1.png)

在上图中，6 台启动 Storage 服务的机器两两组合，加入 3 个 Zone。当指定这三个 Zone 创建分片副本数为 3 的图空间 S1 时，分片副本会均匀存储在 Zone1 ~ Zone3。

## 适用场景

- 期望将图空间创建在某些指定的 Storage 节点上，从而达到资源隔离的目的。

- 集群滚动升级。需要停止一个或多个服务器并更新，然后重新投入使用，直到集群中所有的节点都更新为新版本。
  
- 节省成本。将不同的图空间分配到不同的 Zone 中，并通过控制客户端访问指定的 Zone 内的副本数据，从而减少流量消耗，提高访问效率。

## 注意事项

- 如果当前集群中有数据，需要先清空集群数据，再开启 Zone 功能。有关如何开启 Zone 功能，请参见下文**开启 Zone**。
- 一个 Storage 节点只能属于一个 Zone，但一个 Zone 可以包含多个不同的 Storage 节点。
- 不支持删除 Zone。
- 不支持修改 Zone 的名称。

## 开启 Zone 

1. 在配置文件`nebula-metad.conf`中，手动添加`--zone_list`字段，并设置其值为需要添加的 Zone 的名称，如`--assigned_zone=zone1, zone2, zone3`。

  !!! danger

        一旦`--zone_list`的值配置完并启动 Meta 服务后，不允许被修改，否则再次重启 Meta 服务会失败。

  !!! note

        如果 Zone 的名称使用特殊字符（不包括下划线）、保留关键字，或数字开头时，在查询语句中指定 Zone 名称时需要用反引号（`）包围；Zone 名称中不能使用英文句号（.）；多个 Zone 名称之间使用英文逗号（,）分隔。
   
  关于 Meta 配置文件的详情，参见 [Meta 服务配置](../5.configurations-and-logs/1.configurations/2.meta-config.md)。

2. 重启 Meta 服务。


## 定向访问指定 Zone 

1. 开启 Zone。详情见上文**开启 Zone**。
2. 在配置文件`nebula-graphd.conf`中，添加以下配置：
  
  1. 添加`--assigned_zone`字段，并设置其值为需要访问的 Zone 的名称，如`--assigned_zone=zone1`。
   
    !!! note
      
      - 不同的 Graph 服务可以设置不同的`--assigned_zone`值，但`--assigned_zone`的值必须是`--zone_list`中的一个。
      - `--assigned_zone`的值是一个字符串，不支持使用英文逗号（,）分隔。
      - 当`--assigned_zone`的值为空时，表示访问所有 Zone。
  
  2. 设置`--enable_intra_zone_routing=true`，以开启定向访问指定 Zone 的功能。

    !!! caution

      不同的 Graph 服务中的`--enable_intra_zone_routing`值建议保持一致，否则会导致 Storage 节点的负载不均衡及未知风险。

3. 重启 Graph 服务。

   
关于 Graph 的配置，参见 [Graph 服务配置](../5.configurations-and-logs/1.configurations/3.graph-config.md)。

## Zone 命令

!!! note

    在执行 Zone 命令前，请确保已开启 Zone 功能并配置了`--zone_list`。详情见上文**开启 Zone**。

### 查看所有 Zone 信息

```ngql
nebula> SHOW ZONES;
+--------+-----------------+------+
| Name   | Host            | Port |
+--------+-----------------+------+
| "az1"  | "192.168.8.111" | 9779 |
| "az1"  | "192.168.8.112" | 9779 |
| "az2"  | ""              | 0    |
| "az3"  | ""              | 0    |
+--------+-----------------+------+
```

!!! note
    在当前图空间中，执行`SHOW ZONES`返回是所有的 Zone 信息，而不是当前图空间所在的 Zone 信息。信息中的`Host`和`Port`字段是指定 Zone 中的 Storage 节点的 IP 和端口。

### 查看指定 Zone

```ngql
DESCRIBE ZONE <zone_name>;
DESC ZONE <zone_name>;
```

示例：
```ngql
nebula> DESC ZONE az1
+-----------------+------+
| Hosts           | Port |
+-----------------+------+
| "192.168.8.111" | 7779 |
| "192.168.8.111" | 9779 |
+-----------------+------+
```

### 在 Zone 中创建图空间

```ngql
CREATE SPACE IF NOT EXISTS  (
    [partition_num = <partition_number>,]
    [replica_factor = <replica_number>,]
    vid_type = {FIXED_STRING(<N>) | INT[64]}
    )
    [COMMENT = '<comment>'] 
    [ON <zone_list>];
```

!!! note

    - 创建图空间时指定的 Zone 必须是 Meta 配置文件中`--zone_list`值中的一个或者多个，否则无法创建图空间。
    - 创建图空间时指定的 Zone 必须包含至少一个 Storage 节点，否则无法创建图空间。
    - 创建图空间时指定的分片副本数必须小于等于 Zone 的数量，否则无法创建图空间。

!!! caution

    不建议在开启 Zone 功能并为 Graph 服务配置了访问指定 Zone（设置`--assigned_zone`）的情况下，创建图空间时不指定 Zone。这样会导致无法查询到分布在其他 Zone 中的分片副本数据，因为 Graph 服务只会访问指定 Zone 中的分片副本数据，而创建图空间时不指定 Zone 会使分片副本分布在其他 Zone 中。 

示例：

```ngql
nebula> CREATE SPACE IF NOT EXISTS my_space_1 (vid_type=FIXED_STRING(30)) on az1
```

### 查看图空间的 Zone 信息

```ngql
DESC SPACE <space_name>;
```

示例：

```ngql
nebula> DESC SPACE my_space_1
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| ID | Name         | Partition Number | Replica Factor | Charset | Collate    | Vid Type           | Zones   | Comment |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| 22 | "my_space_1" | 10               | 1              | "utf8"  | "utf8_bin" | "FIXED_STRING(30)" | ["az1"] |         |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
```

### 将 Storage 节点加入 Zone

```ngql
ADD HOSTS <ip>:<port> [,<ip>:<port> ...] INTO ZONE <new_zone_name>;
```

示例：

```ngql
nebula> ADD HOSTS 192.168.8.111:9779,192.168.8.112:9779 INTO ZONE az1;
```

### 迁移 Zone 中的 Storage 节点数据至其他 Storage 节点

```ngql
BALANCE IN ZONE REMOVE <ip>:<port> [,<ip>:<port> ...]
```

!!! note

    - 执行该命令前，需要先指定图空间。
    - 需要确保其他 Storage 节点数量足够以满足设置的分片副本数。当 Storage 节点数量不足时，会导致迁移失败。执行`SHOW JOBS <job_id>`查看迁移任务的状态，当返回`FINISHED`时，表示迁移任务完成。


示例：

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE REMOVE 192.168.8.111:9779;
+------------+
| New Job Id |
+------------+
| 34         |
+------------+

# 查看迁移任务的状态
nebula> SHOW JOBS 34
+--------+----------------+------------+----------------------------+----------------------------+
| Job Id | Command        | Status     | Start Time                 | Stop Time                  |
+--------+----------------+------------+----------------------------+----------------------------+
| 33     | "DATA_BALANCE" | "FINISHED" | 2023-09-01T08:03:16.000000 | 2023-09-01T08:03:16.000000 |
+--------+----------------+------------+----------------------------+----------------------------+
```

### 将 Storage 节点从 Zone 中移除

```ngql
DROP HOSTS <ip>:<port> [,<ip>:<port> ...];
```

!!! note

    无法直接删除正在使用的 Storage 节点，需要先删除关联的图空间，才能删除 Storage 节点。

示例：

```ngql
nebula> DROP HOSTS 192.168.8.111:9779;
```

### 负载均衡 Zone 中的 Storage 节点

```ngql
BALANCE IN ZONE;
```

!!! note

    执行该命令前，需要先指定图空间。

示例：

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE;
```

