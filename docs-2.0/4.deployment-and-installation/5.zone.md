# 管理 Zone


Zone 是{{nebula.name}}中存储（Storage）节点的逻辑机架，它将多个 Storage 节点划分成可管理的逻辑区域，实现资源隔离。同时，用户可以控制 Graph 服务访问指定的 Zone 内的副本数据，从而减少流量消耗，提高访问效率。本文介绍如何使用 Zone 功能。

## 原理介绍

在{{nebula.name}}中，用户可以设置多个 Zone，每个 Zone 包含一个或多个 Storage 节点。之后，在创建图空间指定数据被切分的分片数及各分片的副本数，同时指定图空间中各分片副本数将存储在哪些 Zone 时，就会在这些 Zone 内的 Storage 节点上创建及存储图空间数据。需要注意的是，**指定的分片副本数和设置的 Zone 数量必须相等，否则无法创建图空间**。

当图空间指定 Zone 后，{{nebula.name}}会将图空间数据的各分片副本均匀存储在指定的 Zone 中，并且每个 Zone 中包含完整的图空间数据分片。因为{{nebula.name}}中的分片副本是通过 [Raft](../1.introduction/3.nebula-graph-architecture/4.storage-service.md#raft_1) 协议实现强一致性，其限制分片副本数必须为奇数，因此 Zone 的数量也必须为奇数。

以下图为例，创建图空间时指定的数据切分为 3 分片，各分片副本数为 3，Zone 的数量也为 3；6 台启动 Storage 服务的机器两两组合，加入这 3 个 Zone。在创建图空间时，{{nebula.name}}会将图空间数据的各分片副本均匀存储在 zone1 ~ zone3 中，并且每个 Zone 中包含完整的图空间数据分片（part_1 ~ part_3）。

![Zone 示意图](https://docs-cdn.nebula-graph.com.cn/figures/zone1.png)

同时，为了减少查询时的流量消耗，可以配置 Graph 服务访问指定的单个 Zone。当 Graph 服务访问指定的 Zone 时，Graph 服务会定向访问指定 Zone 中的分片副本数据。

## 适用场景

- 期望将图空间创建在某些指定的 Storage 节点上，从而达到资源隔离的目的。

- 集群滚动升级。需要停止一个或多个服务器并更新，然后重新投入使用，直到集群中所有的节点都更新为新版本。
  
- 节省成本。将不同的图空间分配到不同的 Zone 中，并通过控制客户端访问指定的 Zone 内的副本数据，从而减少流量消耗，提高访问效率。

## 注意事项

- 如果当前集群中有数据，需要先清空集群数据，再开启 Zone 功能。有关如何开启 Zone 功能，请参见下文**开启 Zone**。
- 开启 Zone 功能后：
  - Storage 节点必须归属于一个 Zone。
  - 一个 Storage 节点只能属于一个 Zone，一个 Zone 可以包含多个不同的 Storage 节点。
  - Storage 节点的数量必须大于或等于 Zone 的数量。
- Zone 的数量必须为奇数，并且必须等于分片副本数。
- 不支持变更 Zone 的数量，即不支持增加或减少 Zone。
- 不支持修改 Zone 的名称。

## 开启 Zone 

1. 在配置文件`nebula-metad.conf`中，设置`--zone_list`的值为需要添加的 Zone 的名称，如`--assigned_zone=zone1, zone2, zone3`。

  !!! danger

        一旦`--zone_list`的值配置完并启动 Meta 服务后，不允许被修改，否则再次重启 Meta 服务会失败。

  !!! note

        - 当`--zone_list`为空时，表示不开启 Zone 功能。
        - `--zone_list`中指定的 Zone 的数量必须为奇数，并且必须小于或等于 Storage 节点的数量。
        - 如果 Zone 的名称使用特殊字符（不包括下划线）、保留关键字，或数字开头时，在查询语句中指定 Zone 名称时需要用反引号（`）包围；Zone 名称中不能使用英文句号（.）；多个 Zone 名称之间使用英文逗号（,）分隔。

  关于 Meta 配置文件的详情，参见 [Meta 服务配置](../5.configurations-and-logs/1.configurations/2.meta-config.md)。

2. 重启 Meta 服务。


## 定向访问指定 Zone 

1. 开启 Zone。详情见上文**开启 Zone**。
  
2. 在配置文件`nebula-graphd.conf`中，添加以下配置：
  
  1. 设置`--assigned_zone`的值为需要访问的 Zone 的名称，如`--assigned_zone=zone1`。
   
    !!! note
      
        - 不同的 Graph 服务可以设置不同的`--assigned_zone`值，但`--assigned_zone`的值必须是`--zone_list`中的一个。
        - `--assigned_zone`的值是一个字符串，不支持使用英文逗号（,）分隔。
        - 当`--assigned_zone`的值为空时，表示访问所有 Zone。
  
  2. 设置`--prioritize_intra_zone_routing`的值为`true`，以开启定向访问指定 Zone 的功能。

    !!! caution

        不同的 Graph 服务中的`--prioritize_intra_zone_routing`值建议保持一致，否则会导致 Storage 节点的负载不均衡及未知风险。

  关于 Graph 的配置，参见 [Graph 服务配置](../5.configurations-and-logs/1.configurations/3.graph-config.md)。

3. 重启 Graph 服务。


## Zone 命令

!!! note

    在执行 Zone 命令前，请确保已开启 Zone 功能并配置了`--zone_list`。详情见上文**开启 Zone**。

### 查看所有 Zone 信息

```ngql
nebula> SHOW ZONES;
+--------+-----------------+------+
| Name   | Host            | Port |
+--------+-----------------+------+
| "az1"  | "192.168.8.111" | 9779 |
| "az1"  | "192.168.8.112" | 9779 |
| "az2"  | "192.168.8.113" | 9779 |
| "az3"  | "192.168.8.114" | 9779 | 
+--------+-----------------+------+
```

!!! note

    信息中的`Host`和`Port`字段是指定 Zone 中的 Storage 节点的 IP 和端口。

### 查看指定 Zone 信息

```ngql
DESCRIBE ZONE <zone_name>;
DESC ZONE <zone_name>;
```

示例：
```ngql
nebula> DESC ZONE az1
+-----------------+------+
| Hosts           | Port |
+-----------------+------+
| "192.168.8.111" | 7779 |
| "192.168.8.112" | 9779 |
+-----------------+------+
```

### 在 Zone 中创建图空间

在 Zone 中创建图空间的语法同[创建图空间](../3.ngql-guide/9.space-statements/1.create-space.md)中的语法，只是在创建图空间时，系统会自动识别 Meta 配置文件中`--zone_list`的值，如果其值不为空并且值中的 Zone 的数量等于通过`replica_factor`指定的分片副本数时，图空间的各分片副本会均匀分布在`--zone_list`中指定的 Zone 中。当指定的分片副本数不等于 Zone 的数量时，会导致创建图空间失败。

如果`--zone_list`的值为空，代表不开启 Zone 功能，此时创建图空间时，不会指定图空间的 Zone。

### 查看图空间的 Zone 信息

```ngql
DESC SPACE <space_name>;
```

示例：

```ngql
nebula> DESC SPACE my_space_1
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| ID | Name         | Partition Number | Replica Factor | Charset | Collate    | Vid Type           | Zones   | Comment |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
| 22 | "my_space_1" | 10               | 1              | "utf8"  | "utf8_bin" | "FIXED_STRING(30)" | ["az1"] |         |
+----+--------------+------------------+----------------+---------+------------+--------------------+---------+---------+
```

### 将 Storage 节点加入 Zone

```ngql
ADD HOSTS <ip>:<port> [,<ip>:<port> ...] INTO ZONE <zone_name>;
```

!!! note

    - 开启 Zone 功能后，执行`ADD HOSTS`命令时必须指定`INTO ZONE`子句，否则会导致添加 Storage 节点失败。
    - 一个 Storage 节点只能属于一个 Zone，一个 Zone 可以包含多个不同的 Storage 节点。

示例：

```ngql
nebula> ADD HOSTS 192.168.8.111:9779,192.168.8.112:9779 INTO ZONE az1;
```

### 负载均衡 Zone 中的 Storage 节点

```ngql
BALANCE DATA IN ZONE [<zone_name>];
```

!!! note

    执行该命令前，需要先指定图空间。

当开启 Zone 后，执行`BALANCE DATA IN ZONE`命令时，会在当前图空间中的所有 Zone 内均衡分布分片副本。如果通过`<zone_name>`选项指定了某个 Zone 时，则会在指定的 Zone 内的 Storage 节点中均衡分布分片副本。


示例：

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE;
```

### 迁移 Zone 中的 Storage 节点数据至其他 Storage 节点

```ngql
BALANCE DATA IN ZONE REMOVE <ip>:<port> [,<ip>:<port> ...]
```

!!! note

    - 执行该命令前，需要先指定图空间。
    - 需要确保其他 Storage 节点数量足够以满足设置的分片副本数。当 Storage 节点数量不足时，会导致迁移失败。执行`SHOW JOBS <job_id>`查看迁移任务的状态，当返回`FINISHED`时，表示迁移任务完成。


示例：

```ngql
nebula> USE my_space_1;
nebula> BALANCE IN ZONE REMOVE 192.168.8.111:9779;
+------------+
| New Job Id |
+------------+
| 34         |
+------------+

# 查看迁移任务的状态
nebula> SHOW JOBS 34
+--------+----------------+------------+----------------------------+----------------------------+
| Job Id | Command        | Status     | Start Time                 | Stop Time                  |
+--------+----------------+------------+----------------------------+----------------------------+
| 33     | "DATA_BALANCE" | "FINISHED" | 2023-09-01T08:03:16.000000 | 2023-09-01T08:03:16.000000 |
+--------+----------------+------------+----------------------------+----------------------------+
```

### 将 Storage 节点从 Zone 中移除

```ngql
DROP HOSTS <ip>:<port> [,<ip>:<port> ...];
```

!!! note

    - 无法直接删除正在使用的 Storage 节点，需要先删除关联的图空间，才能删除 Storage 节点。
    - 移除 Storage 节点后，确保剩余 Storage 节点数量足够满足设置的 Zone 数量，否则会导致图空间无法正常使用。

示例：

```ngql
nebula> DROP HOSTS 192.168.8.111:9779;
```



